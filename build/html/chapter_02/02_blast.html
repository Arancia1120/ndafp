

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>构建本地 Blast 应用 &mdash; NGS Data Analysis for Pathogens 0.0.1a 文档</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="NGS Data Analysis for Pathogens 0.0.1a 文档" href="../index.html"/>
        <link rel="up" title="第二章. 序列比对" href="01_index.html"/>
        <link rel="next" title="多重序列比对" href="03_msa.html"/>
        <link rel="prev" title="第二章. 序列比对" href="01_index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> NGS Data Analysis for Pathogens
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1a
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../chapter_01/01_index.html">第一章. 基因组数据分析</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="01_index.html">第二章. 序列比对</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">构建本地 Blast 应用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#local-blast">Local Blast 使用说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1. 基于命令行的 Local Blast</a></li>
<li class="toctree-l4"><a class="reference internal" href="#blast-web">2. 构建自己的blast web服务</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="03_msa.html">多重序列比对</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_mapping.html">Reads Mapping</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">NGS Data Analysis for Pathogens</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="01_index.html">第二章. 序列比对</a> &raquo;</li>
      
    <li>构建本地 Blast 应用</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/chapter_02/02_blast.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="blast">
<h1>构建本地 Blast 应用<a class="headerlink" href="#blast" title="永久链接至标题">¶</a></h1>
<p><a class="reference external" href="http://blast.ncbi.nlm.nih.gov/Blast.cgi">blast</a> 工具用来进行序列相似性比对。常见的使用是通过访问 <a class="reference external" href="http://blast.ncbi.nlm.nih.gov/Blast.cgi">http://blast.ncbi.nlm.nih.gov/Blast.cgi</a> 使用。</p>
<div class="section" id="local-blast">
<h2>Local Blast 使用说明<a class="headerlink" href="#local-blast" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last"><a class="reference external" href="http://blast.ncbi.nlm.nih.gov/Blast.cgi">blast</a> 工具可以进行序列相似性比对。在 NGS 数据分析中经常会被使用到，特别是一些工具中需要使用 blast 来作序列比对。拿到测序完成的草图后，因为基因组数据较大，连接NCBI网站往往又非常缓慢，所以要做 Blast 比对的话都需要做 Local Blast。这里介绍2个方式来实现：</p>
</div>
<ol class="arabic simple">
<li>用命令行进行 Blast</li>
<li>快速构建 Blast Web 服务</li>
</ol>
<div class="section" id="id1">
<h3>1. 基于命令行的 Local Blast<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><strong>blast</strong> 和 <strong>ncbi_blast+</strong> 这2个程序集容易搞混。NCBI 最早在1989年创建 Basic Local Alignment Search Tool 工具，沿用至2009年无论是命令行工具或是在线程序，都称呼其为blast。2009年 NCBI 鉴于 <code class="docutils literal"><span class="pre">blast</span></code> 的一些不足，重新开发了新的 ncbi_blast+ 命令行工具，新的 ncbi_blast+ 工具在速度上有了提升，在输入输出上也更为灵活。</p>
<p>目前 Blast 工具最新版是2012年发布的<strong>2.2.26</strong>（已经暂停版本更新并不做进一步支持），而 ncbi_blast+ 目前一直在更新。要区分2者也很简单，blast 是通过 blastall -p 的方式调用子程序来比对搜索的，而 blast+ 则是直接使用 blastn 或 blastp 等子程序来比对搜索。另外前者用 formatdb 程序来格式化数据库，后者用 makeblastdb 程序来格式化数据。</p>
<div class="section" id="id2">
<h4>1.1 Blast<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p><strong>Blast的下载与安装</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># 安装 Ubuntu 编译包。</span>
~$ sudo apt-get install blast2

<span class="c1"># 或者直接下载NCBI Linux预编译包，并解压缩安装</span>
~$ wget ftp://ftp.ncbi.nih.gov/blast/executables/legacy/2.2.26/blast-2.2.26-x64-linux.tar.gz
~$ tar zxvf blast-2.2.26-x64 -C ~/app
~$ sudo ln -s ~/app/blast-2.2.26-x64/blastall /usr/local/sbin
</pre></div>
</div>
<p><strong>运行 Blast</strong></p>
<p>Blast 通过调用 blastall 这个程序来调用不同算法和程序实现序列比对。在命令行中输入 blastall ，会打印出一份参数列表。你也可以使用 <code class="docutils literal"><span class="pre">man</span> <span class="pre">blast</span></code> 来查看 Blast 工具的用户手册。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~$ blastall
</pre></div>
</div>
<p><strong>参数说明：</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>-p: 指定要运行的 blast 程序。可以调用的有:
    blastp             将氨基酸序列与蛋白质数据库比对
    blastn             将核酸序列与核酸数据库比对
    blastx             将核酸序列翻译成蛋白序列后与非冗余<span class="o">(</span>nr<span class="o">)</span>蛋白质数据库比对
    psitblastn
    tblastn
    tblastx
-d: 指定要调用数据库，默认值是非冗余<span class="o">(</span>nr<span class="o">)</span>数据库。本地 Blast 比对一般来说都是调用 formatdb 格式化的数据库。
-i: 输入，默认值是终端输入，也可以使用文件的方式，比如 -i seq.fasta
-o: 输出，默认值是终端打印输出，也可以使用文件的方式，比如 -o result.txt
-e: 期望值。
-T: 输出文件格式，默认值为F<span class="o">(</span>False<span class="o">)</span>，想输出HTML格式的可以用 -T T
-M: 矩阵算法选择，默认值是 BLOSUM62
-n: 如果想使用MegaBlast，就设置 -n T
-b: 数据库中的比对结果显示条目数，默认是250条记录。
-m: 比对结果的输出显示方式，值为0~11，默认是0。各个数字含义见下表。
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">数值</th>
<th class="head">代表含义</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>pairwise</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>query-anchored showing identities</td>
</tr>
<tr class="row-even"><td>2</td>
<td>query-anchored no identities</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>flat query-anchored, show identities</td>
</tr>
<tr class="row-even"><td>4</td>
<td>flat query-anchored, no identities</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>query-anchored no identities and blunt ends</td>
</tr>
<tr class="row-even"><td>6</td>
<td>flat query-anchored, no identities and blunt ends</td>
</tr>
<tr class="row-odd"><td>7</td>
<td>XML Blast output</td>
</tr>
<tr class="row-even"><td>8</td>
<td>tabular</td>
</tr>
<tr class="row-odd"><td>9</td>
<td>tabular with comment lines</td>
</tr>
<tr class="row-even"><td>10</td>
<td>ASN, text</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>ASN, binary [Integer]</td>
</tr>
</tbody>
</table>
<p>其他参数参见<code class="docutils literal"><span class="pre">man</span> <span class="pre">blast</span></code>。</p>
<p><strong>应用举例:</strong></p>
<p>Local blast例子：获得一条大肠杆菌序列 myseq.fasta，要和 EDL933 进行比对。首先下载 EDL933 的基因组数据，并格式化作为本地数据库，然后使用 blastn 对序列进行比对。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># 使用 edirect 工具的 efetch 下载 EDL933 基因组数据</span>
~$ efetch <span class="nv">db</span><span class="o">=</span>nuccore -format<span class="o">=</span>fasta -id<span class="o">=</span>AE005174 &gt; AE005174.fasta
<span class="c1"># 使用 blast 的 formatdb 工具将 EDL933 基因组数据格式化成用于比对的数据库格式</span>
~$ formatdb -i AE005174.2.fasta -o T -p F
<span class="c1"># 调用 blastn 的方式比对 myseq.fasta 和 EDL933 序列</span>
~$ blastall -i myseq.fasta -d AE005174.2.fasta -p blastn
</pre></div>
</div>
</div>
<div class="section" id="ncbi-blast">
<h4>1.2 NCBI_blast+<a class="headerlink" href="#ncbi-blast" title="永久链接至标题">¶</a></h4>
<p>目前 NCBI_blast+ 最新版为 v2.4.0。</p>
<p><strong>下载安装 NCBI Blast+</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># 安装 Ubuntu 编译包</span>
~$ sudo apt-get install ncbi-blast+

<span class="c1"># 直接在 NCBI 官方 FTP 站点下载预编译包解压缩安装</span>
~/tmp$ wget ftp://ftp.ncbi.nih.gov/blast/executables/blast+/2.4.0/ncbi-blast-2.4.0+-x64-linux.tar.gz
~/tmp$ tar zxf ncbi-blast-2.4.0+-x64-linux.tar.gz
</pre></div>
</div>
<p><strong>构建数据库</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~$ makeblastdb -in data/database.fasta -dbtype nucl -parse_seqids
</pre></div>
</div>
<p><a class="reference external" href="http://www.personal.psu.edu/iua1/courses/files/2014/lecture-12.pdf">http://www.personal.psu.edu/iua1/courses/files/2014/lecture-12.pdf</a></p>
</div>
</div>
<div class="section" id="blast-web">
<h3>2. 构建自己的blast web服务<a class="headerlink" href="#blast-web" title="永久链接至标题">¶</a></h3>
<div class="section" id="blastkit">
<h4>2.1 blastkit<a class="headerlink" href="#blastkit" title="永久链接至标题">¶</a></h4>
<p>blastkit 是一个包含webserver等工具的blast工具集。</p>
<p><strong>安装依赖包</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~$ sudo pip install pygr
~$ sudo pip install whoosh
~$ sudo pip install git+https://github.com/ctb/pygr-draw.git
~$ sudo pip install git+https://github.com/ged-lab/screed.git
~$ sudo apt-get -y install lighttpd
</pre></div>
</div>
<p><strong>对lighttpd webserver进行配置</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~$ <span class="nb">cd</span> /etc/lighttpd/conf-enabled
~$ sudo ln -fs ../conf-available/10-cgi.conf ./
~$ sudo <span class="nb">echo</span> <span class="s1">&#39;cgi.assign = ( &quot;.cgi&quot; =&gt; &quot;&quot; )&#39;</span> &gt;&gt; 10-cgi.conf
~$ sudo <span class="nb">echo</span> <span class="s1">&#39;index-file.names += ( &quot;index.cgi&quot; ) &#39;</span> &gt;&gt; 10-cgi.conf
~$ sudo /etc/init.d/lighttpd restart
</pre></div>
</div>
<p><strong>本地安装 Blast</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~$ <span class="nb">cd</span> tmp
~/tmp$ wget ftp://ftp.ncbi.nih.gov/blast/executables/legacy/2.2.26/blast-2.2.26-x64-linux.tar.gz
~/tmp$ tar xzf blast-2.2.26-x64-linux.tar.gz -C ~/app
~/tmp$ sudo cp ~/app/blast-2.2.26/bin/* /usr/local/sbin
~/tmp$ sudo cp -r ~/app/blast-2.2.26/data /usr/local/blast-data
</pre></div>
</div>
<p><strong>安装 blastkit</strong></p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~/tmp$ <span class="nb">cd</span> ~/app
~/app$ git clone https://github.com/ctb/blastkit.git -b ec2
~/app$ <span class="nb">cd</span> blastkit/www
~/app/blastkit/www$ sudo ln -fs <span class="nv">$PWD</span> /var/www/blastkit
~/app/blastkit/www$ mkdir files
~/app/blastkit/www$ chmod a+rxwt files
~/app/blastkit/www$ chmod +x /root
~/app/blastkit/www$ <span class="nb">cd</span> ..
~/app/blastkit$ python ./check.py
</pre></div>
</div>
<p>如果安装顺利，就会提示一切已经准备完毕。接下来要准备数据。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>~$ cp /mnt/assembly/ecoli.21/contigs.fa ~/app/blastkit/db/db.fa
~$ <span class="nb">cd</span> ~/app/blastkit
~$ formatdb -i db/db.fa -o T -p F
~$ python index-db.py db/db.fa
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ctb/blastkit.git">Blastkit</a></li>
<li><a class="reference external" href="https://github.com/dib-lab/2013-caltech-workshop/blob/master/blastkit.txt">Caltech workshop</a></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="03_msa.html" class="btn btn-neutral float-right" title="多重序列比对" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="01_index.html" class="btn btn-neutral" title="第二章. 序列比对" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; 版权所有 2016, Mark Renton.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.0.1a',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>